<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Prix spot vs ARENH — série mensuelle (€/MWh)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --pn-text:#0b0f19;
      --pn-muted:#64748b;
      --pn-grid:rgba(0,0,0,0.06);
      --pn-spot:#5A52FF;   /* violet papernest */
      --pn-arenh:#334155;  /* gris ARENH */
    }
    body{
      margin:0; overflow:hidden; background:#fff;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display:flex; justify-content:center; padding:40px 16px;
    }
    .chart-wrapper{ width:100%; max-width:1100px; }
    h1{ margin:0 0 10px; text-align:center; font-size:22px; font-weight:600; color:var(--pn-text); }
    .legend-note{ margin:0 0 12px; text-align:center; color:var(--pn-muted); font-size:13px; }
    canvas{ width:100% !important; height:auto !important; }
    .err{ margin-top:10px; text-align:center; color:#ef4444 }
  </style>
</head>
<body>
  <div class="chart-wrapper">
    <h1>Évolution du prix spot de l'électricité en France</h1>
    <div class="legend-note">Unité : <strong>€/MWh</strong></div>
    <canvas id="chart"></canvas>
  </div>

  <script>
    const CSV_URL = "https://raw.githubusercontent.com/FEPPN/graph_prix_spot/main/data_prix_spot.csv";

    // --- Helpers ---
    const parseNumberSmart = (s) => s==null ? NaN : Number(String(s).trim().replace(/\s+/g,'').replace(',', '.'));
    function detectSep(headerLine){
      const tc=(headerLine.match(/\t/g)||[]).length, sc=(headerLine.match(/;/g)||[]).length, cc=(headerLine.match(/,/g)||[]).length;
      if (tc>0) return '\t'; if (sc>=cc) return ';'; return ',';
    }
    const FR_MONTHS = {"janv.":1,"févr.":2,"mars":3,"avr.":4,"mai":5,"juin":6,"juil.":7,"août":8,"sept.":9,"oct.":10,"nov.":11,"déc.":12};
    function toKey(ym){ const p=String(ym).trim().split(/\s+/); const m=FR_MONTHS[(p[0]||'').toLowerCase()]; const y=Number(p[1]); return (m&&Number.isFinite(y))?`${y}-${String(m).padStart(2,'0')}`:ym; }
    function keyToFR(k){ const [y,m]=k.split('-').map(Number); const rev=Object.entries(FR_MONTHS).reduce((a,[n,i])=>(a[i]=n,a),{}); return `${rev[m]} ${y}`; }

    // construit la liste voulue pour l'axe X : 2011-01, 2012-01, puis 2017-01 → max
    function buildDesiredKeys(minKeyInData, maxKeyInData){
      const keys = ["2011-01","2012-01"];
      // point de départ continu côté spot
      const start = "2017-01";
      // borne haute = maxKeyInData
      let [y,m] = start.split('-').map(Number);
      const [Y,M] = maxKeyInData.split('-').map(Number);
      while (y < Y || (y===Y && m<=M)){
        keys.push(`${y}-${String(m).padStart(2,'0')}`);
        m++; if (m>12){ m=1; y++; }
      }
      return keys;
    }

    fetch(CSV_URL + "?v=" + Date.now(), { cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error(`Impossible de charger le CSV (HTTP ${r.status})`); return r.text(); })
      .then(text => {
        text = text.replace(/^\uFEFF/, '');
        const lines = text.split(/\r?\n/).filter(l => l.trim().length>0);
        if (lines.length <= 1) throw new Error("CSV vide");

        const sep = detectSep(lines[0]);
        const header = lines[0].split(sep).map(h => h.trim().toLowerCase());
        const idxYM    = header.findIndex(h => /year[_\s-]*month|mois|p[eé]riode/.test(h));
        const idxSpot  = header.findIndex(h => /prix.*mwh|mwh.*prix|spot/.test(h));
        const idxArenh = header.findIndex(h => /arenh/.test(h));
        if (idxYM<0 || idxSpot<0 || idxArenh<0) throw new Error("Colonnes introuvables (year_month, prix Mwh, arenh price)");

        // indexation par clé AAAA-MM
        const spotByKey = Object.create(null);
        const arenhByKey = Object.create(null);
        let maxKey = "2017-01"; // par défaut

        for (let i=1;i<lines.length;i++){
          const cols = lines[i].split(sep);
          const ymRaw=(cols[idxYM]??"").trim();
          if (!ymRaw) continue;
          const key = toKey(ymRaw);
          const spot = parseNumberSmart(cols[idxSpot]);
          const arenh = parseNumberSmart(cols[idxArenh]);

          if (Number.isFinite(spot)) spotByKey[key] = spot;
          if (Number.isFinite(arenh)) arenhByKey[key] = arenh;

          if (typeof key==="string" && /^\d{4}-\d{2}$/.test(key)){
            if (key > maxKey) maxKey = key;
          }
        }

        // Axe X voulu
        const xKeys = buildDesiredKeys("2011-01", maxKey);
        const labels = xKeys.map(keyToFR);

        // Séries
        const spotVals  = xKeys.map(k => (k>="2017-01" && k in spotByKey) ? spotByKey[k] : null);

        // Segment mise en valeur 2011-01 → 2012-01
        const arenhEarly = xKeys.map(k => (k==="2011-01"||k==="2012-01") ? (arenhByKey[k] ?? (k==="2011-01"?41:(k==="2012-01"?42:null))) : null);

        // Ligne pointillée à partir de 2017-01, valeur 42 (si non fournie dans CSV)
        const arenhLater = xKeys.map(k => (k>="2017-01") ? ( (k in arenhByKey) ? arenhByKey[k] : 42 ) : null);

        drawChart(labels, spotVals, arenhEarly, arenhLater);
      })
      .catch(err => {
        console.error(err);
        document.querySelector('.chart-wrapper')
          .insertAdjacentHTML('beforeend', `<p class="err">Erreur : ${err.message}</p>`);
      });

    function drawChart(labels, spotVals, arenhEarly, arenhLater){
      const ctx = document.getElementById('chart').getContext('2d');

      const grad = ctx.createLinearGradient(0,0,0,300);
      grad.addColorStop(0, "rgba(90,82,255,0.20)");
      grad.addColorStop(1, "rgba(90,82,255,0.00)");

      const spotColor  = getComputedStyle(document.documentElement).getPropertyValue('--pn-spot').trim()  || "#5A52FF";
      const arenhColor = getComputedStyle(document.documentElement).getPropertyValue('--pn-arenh').trim() || "#334155";

      new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {
              label:"Prix spot (€/MWh)",
              data: spotVals,
              borderColor: spotColor,
              backgroundColor: grad,
              borderWidth: 1.8,
              pointRadius: 0,
              tension: 0.25,
              fill: true,
              spanGaps: false
            },
            {
              label:"ARENH (€/MWh)",
              data: arenhEarly,                // 2011-01 & 2012-01 uniquement
              borderColor: arenhColor,
              backgroundColor:"transparent",
              borderWidth: 2.4,
              pointRadius: (c)=> arenhEarly[c.dataIndex]!=null ? 3.5 : 0,
              pointBackgroundColor: arenhColor,
              tension: 0,
              fill: false,
              spanGaps: false
            },
            {
              label:"ARENH (€/MWh)",
              data: arenhLater,                // dès 2017-01 → 42
              borderColor: arenhColor,
              backgroundColor:"transparent",
              borderWidth: 1.6,
              pointRadius: 0,
              tension: 0,
              fill: false,
              borderDash:[6,4],
              spanGaps:false
            }
          ]
        },
        options:{
          responsive:true,
          interaction:{ mode:'nearest', intersect:false },
          plugins:{
            legend:{
              position:"bottom",
              labels:{
                color:"#1f2937",
                font:{ size:13, weight:"600" },
                // n’afficher “ARENH” qu’une fois
                filter:(item, data)=>{
                  if (item.text === "Prix spot (€/MWh)") return true;
                  const first = data.datasets.findIndex(d=>d.label==="ARENH (€/MWh)");
                  return item.datasetIndex === first;
                }
              }
            },
            tooltip:{
              backgroundColor:"#fff", borderColor:"#e5e7eb", borderWidth:1,
              titleColor:"#111827", bodyColor:"#4b5563",
              titleFont:{ weight:'700' }, bodyFont:{ weight:'500' },
              padding:10, cornerRadius:10,
              callbacks:{
                label:(ctx)=>{
                  const v = ctx.parsed.y;
                  if (!Number.isFinite(v)) return;
                  return `${ctx.dataset.label} : ${v.toFixed(2)} €/MWh`;
                }
              }
            }
          },
          scales:{
            y:{
              ticks:{ color:"#6b7280", callback:v=>`${Number(v).toFixed(0)}` },
              grid:{ color:"rgba(0,0,0,0.06)" },
              border:{ display:false }
            },
            x:{
              offset:true,
              ticks:{
                color:"#6b7280",
                autoSkip:false,         // ← afficher tous les mois demandés
                maxRotation:0,
                minRotation:0,
                font:{ size:10 }
              },
              grid:{ display:false },
              border:{ display:false }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
